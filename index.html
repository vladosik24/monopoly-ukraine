<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–Ω–æ–ø–æ–ª—ñ—è –£–∫—Ä–∞—ó–Ω–∞ üá∫üá¶</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body style="font-family:Arial;background:#e3f2fd;padding:20px;margin:0;">
    <div style="max-width:500px;margin:0 auto;background:white;padding:30px;border-radius:15px;box-shadow:0 4px 20px rgba(0,0,0,0.1);">
        <h1 style="text-align:center;color:#1565c0;margin-bottom:30px;">üá∫üá¶ –ú–æ–Ω–æ–ø–æ–ª—ñ—è –£–∫—Ä–∞—ó–Ω–∞</h1>
        
        <div id="status" style="padding:15px;background:#fff3e0;border-radius:8px;text-align:center;margin:20px 0;">
            –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...
        </div>
        
        <div id="lobby" style="display:none;">
            <input type="text" id="playerName" placeholder="–í–∞—à–µ —ñ–º'—è" value="–ì—Ä–∞–≤–µ—Ü—å" style="width:100%;padding:15px;margin:10px 0;border:2px solid #ddd;border-radius:8px;font-size:16px;box-sizing:border-box;">
            
            <button onclick="createRoom()" style="width:100%;padding:15px;margin:10px 0;background:#4caf50;color:white;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;transition:0.3s;" onmouseover="this.style.background='#45a049'" onmouseout="this.style.background='#4caf50'">
                üéØ –°—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É
            </button>
            
            <div style="text-align:center;margin:15px 0;color:#666;font-weight:bold;">‚Äî –ê–ë–û ‚Äî</div>
            
            <input type="text" id="roomCode" placeholder="–ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏" style="width:100%;padding:15px;margin:10px 0;border:2px solid #ddd;border-radius:8px;font-size:16px;text-transform:uppercase;box-sizing:border-box;">
            
            <button onclick="joinRoom()" style="width:100%;padding:15px;margin:10px 0;background:#2196f3;color:white;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;transition:0.3s;" onmouseover="this.style.background='#1976d2'" onmouseout="this.style.background='#2196f3'">
                üö™ –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è
            </button>
            
            <div id="waiting" style="display:none;">
                <div style="background:#f5f5f5;padding:20px;border-radius:8px;text-align:center;margin:20px 0;">
                    <div style="font-size:0.9rem;margin-bottom:10px;color:#666;">üìã –ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏:</div>
                    <div id="codeDisplay" style="font-size:2rem;font-weight:bold;color:#1565c0;letter-spacing:3px;"></div>
                </div>
                
                <div id="playersList" style="background:#f9f9f9;padding:15px;border-radius:8px;margin:15px 0;"></div>
                
                <button onclick="startGame()" id="startBtn" disabled style="width:100%;padding:15px;background:#ff9800;color:white;border:none;border-radius:8px;font-size:18px;font-weight:bold;cursor:pointer;opacity:0.6;">
                    –û—á—ñ–∫—É–≤–∞–Ω–Ω—è...
                </button>
            </div>
        </div>
        
        <div id="game" style="display:none;">
            <div style="background:#1565c0;color:white;padding:12px 20px;border-radius:8px;margin-bottom:15px;">
                <div>üéÆ –ö—ñ–º–Ω–∞—Ç–∞: <span id="gameCode" style="font-weight:bold;"></span></div>
            </div>
            <div id="gamePlayers" style="margin-bottom:15px;"></div>
            <button onclick="rollDice()" id="rollBtn" style="width:100%;padding:15px;background:#2196f3;color:white;border:none;border-radius:8px;font-size:16px;font-weight:bold;margin:10px 0;cursor:pointer;">
                üé≤ –ö–∏–Ω—É—Ç–∏ –∫—É–±–∏–∫–∏
            </button>
            <div id="diceResult" style="text-align:center;font-size:3rem;margin:15px 0;display:none;"></div>
            <div id="gameLog" style="background:#f9f9f9;padding:15px;border-radius:8px;max-height:200px;overflow-y:auto;font-size:14px;"></div>
        </div>
    </div>

    <script>
        const config = {
            apiKey: "AIzaSyByYh0VOBkFvPcQYRzabrt8sfj32gpbsWQ",
            authDomain: "monopoly-ukraine.firebaseapp.com",
            databaseURL: "https://monopoly-ukraine-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "monopoly-ukraine",
            storageBucket: "monopoly-ukraine.firebasestorage.app",
            messagingSenderId: "1046709502750",
            appId: "1:1046709502750:web:ba8ad3c1f11780d1a6bf0f"
        };

        const COLORS = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#A8E6CF'];
        const COLOR_NAMES = ['üî¥ –ß–µ—Ä–≤–æ–Ω–∏–π', 'üîµ –ë–ª–∞–∫–∏—Ç–Ω–∏–π', 'üü° –ñ–æ–≤—Ç–∏–π', 'üü¢ –ó–µ–ª–µ–Ω–∏–π'];

        let db;
        try {
            firebase.initializeApp(config);
            db = firebase.database();
            
            db.ref('.info/connected').on('value', snap => {
                const status = document.getElementById('status');
                if (snap.val()) {
                    status.innerHTML = '‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ!';
                    status.style.background = '#e8f5e9';
                    setTimeout(() => {
                        status.style.display = 'none';
                        document.getElementById('lobby').style.display = 'block';
                    }, 1500);
                }
            });
        } catch(e) {
            document.getElementById('status').innerHTML = '‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message;
            document.getElementById('status').style.background = '#ffebee';
        }

        const myId = 'p' + Date.now();
        let myRoom = null;
        let myName = null;

        function generateCode() {
            return 'GAME-' + Math.random().toString(36).substr(2, 4).toUpperCase();
        }

        async function createRoom() {
            myName = document.getElementById('playerName').value.trim() || '–ì—Ä–∞–≤–µ—Ü—å';
            myRoom = generateCode();

            await db.ref('rooms/' + myRoom).set({
                status: 'waiting',
                players: {
                    [myId]: { 
                        id: myId, 
                        name: myName, 
                        pos: 0, 
                        money: 15000, 
                        online: true,
                        color: COLORS[0],
                        colorName: COLOR_NAMES[0]
                    }
                },
                game: { current: 0, dice1: 1, dice2: 1 }
            });

            document.getElementById('codeDisplay').textContent = myRoom;
            document.getElementById('waiting').style.display = 'block';
            
            listen();
        }

        async function joinRoom() {
            myName = document.getElementById('playerName').value.trim() || '–ì—Ä–∞–≤–µ—Ü—å';
            myRoom = document.getElementById('roomCode').value.trim().toUpperCase();

            if (!myRoom) {
                alert('–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥!');
                return;
            }

            const snap = await db.ref('rooms/' + myRoom).once('value');
            if (!snap.val()) {
                alert('–ö—ñ–º–Ω–∞—Ç—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
                return;
            }

            const players = Object.values(snap.val().players || {});
            const colorIndex = players.length;

            if (colorIndex >= 4) {
                alert('–ö—ñ–º–Ω–∞—Ç–∞ –ø–æ–≤–Ω–∞ (–º–∞–∫—Å–∏–º—É–º 4 –≥—Ä–∞–≤—Ü—ñ)!');
                return;
            }

            await db.ref('rooms/' + myRoom + '/players/' + myId).set({
                id: myId, 
                name: myName, 
                pos: 0, 
                money: 15000, 
                online: true,
                color: COLORS[colorIndex],
                colorName: COLOR_NAMES[colorIndex]
            });

            document.getElementById('codeDisplay').textContent = myRoom;
            document.getElementById('waiting').style.display = 'block';
            
            listen();
        }

        function listen() {
            db.ref('rooms/' + myRoom).on('value', snap => {
                const room = snap.val();
                if (!room) return;

                if (room.status === 'waiting') {
                    const players = Object.values(room.players || {});
                    document.getElementById('playersList').innerHTML = players.map(p => 
                        '<div style="padding:12px;margin:8px 0;background:white;border-radius:8px;border-left:6px solid ' + p.color + ';box-shadow:0 2px 4px rgba(0,0,0,0.1);">' + 
                        '<strong>' + p.name + '</strong> ' + p.colorName + ' ' + (p.online ? 'üü¢' : 'üî¥') +
                        '</div>'
                    ).join('');

                    const btn = document.getElementById('startBtn');
                    btn.disabled = players.length < 2;
                    btn.style.opacity = players.length < 2 ? '0.6' : '1';
                    btn.style.cursor = players.length < 2 ? 'not-allowed' : 'pointer';
                    btn.textContent = players.length < 2 ? 
                        '–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –≥—Ä–∞–≤—Ü—ñ–≤ (' + players.length + '/2)' : 
                        '–ü–æ—á–∞—Ç–∏ –≥—Ä—É (' + players.length + ' –≥—Ä–∞–≤—Ü—ñ–≤)';
                } else if (room.status === 'playing') {
                    showGame(room);
                }
            });
        }

        async function startGame() {
            await db.ref('rooms/' + myRoom).update({ status: 'playing' });
        }

        function showGame(room) {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            document.getElementById('gameCode').textContent = myRoom;

            const players = Object.values(room.players || {});
            document.getElementById('gamePlayers').innerHTML = players.map((p, i) => 
                '<div style="padding:12px;margin:8px 0;background:' + 
                (i === room.game.current ? '#e3f2fd' : 'white') + 
                ';border-radius:8px;border:3px solid ' + 
                (i === room.game.current ? p.color : '#ddd') + 
                ';box-shadow:0 2px 4px rgba(0,0,0,0.1);">' +
                '<div style="display:flex;justify-content:space-between;align-items:center;">' +
                '<div>' +
                '<strong style="font-size:16px;">' + p.name + (p.id === myId ? ' (–í–∏)' : '') + '</strong><br>' +
                '<span style="color:#666;">' + p.colorName + '</span>' +
                '</div>' +
                '<div style="text-align:right;">' +
                '<div style="font-size:20px;font-weight:bold;color:#4caf50;">' + p.money + '‚Ç¥</div>' +
                '<div style="font-size:12px;color:#666;">–ü–æ–∑–∏—Ü—ñ—è: ' + p.pos + '</div>' +
                '</div>' +
                '</div>' +
                '</div>'
            ).join('');

            const btn = document.getElementById('rollBtn');
            const isMyTurn = players[room.game.current].id === myId;
            btn.disabled = !isMyTurn;
            btn.style.opacity = isMyTurn ? '1' : '0.6';
            btn.style.cursor = isMyTurn ? 'pointer' : 'not-allowed';
            btn.textContent = isMyTurn ? 'üé≤ –í–∞—à —Ö—ñ–¥ - –ö–∏–Ω—É—Ç–∏ –∫—É–±–∏–∫–∏' : '‚è≥ –ß–µ–∫–∞–π—Ç–µ —Å–≤–æ–≥–æ —Ö–æ–¥—É...';

            // –ü–æ–∫–∞–∑—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫—É–±–∏–∫—ñ–≤
            if (room.game.dice1 && room.game.dice2) {
                document.getElementById('diceResult').style.display = 'block';
                document.getElementById('diceResult').innerHTML = 
                    'üé≤ ' + room.game.dice1 + ' + ' + room.game.dice2 + ' = ' + (room.game.dice1 + room.game.dice2);
            }
        }

        async function rollDice() {
            const snap = await db.ref('rooms/' + myRoom).once('value');
            const room = snap.val();
            const players = Object.values(room.players);
            
            if (players[room.game.current].id !== myId) {
                alert('–ù–µ –≤–∞—à —Ö—ñ–¥!');
                return;
            }

            const d1 = Math.floor(Math.random() * 6) + 1;
            const d2 = Math.floor(Math.random() * 6) + 1;
            const total = d1 + d2;

            const currentPlayer = players[room.game.current];
            const newPos = (currentPlayer.pos + total) % 40;

            await db.ref('rooms/' + myRoom + '/players/' + currentPlayer.id).update({
                pos: newPos
            });

            await db.ref('rooms/' + myRoom + '/game').update({ 
                dice1: d1, 
                dice2: d2,
                current: (room.game.current + 1) % players.length
            });

            const log = myName + ' –≤–∏–∫–∏–Ω—É–≤ üé≤ ' + d1 + '+' + d2 + ' = ' + total + ' (–ø–æ–∑–∏—Ü—ñ—è: ' + newPos + ')';
            await db.ref('rooms/' + myRoom + '/logs').push({ text: log, time: Date.now() });

            updateLog(room);
        }

        function updateLog(room) {
            db.ref('rooms/' + myRoom + '/logs').limitToLast(10).on('value', snap => {
                const logs = [];
                snap.forEach(child => logs.push(child.val()));
                document.getElementById('gameLog').innerHTML = logs.reverse().map(l => 
                    '<div style="padding:8px;margin:4px 0;background:white;border-radius:4px;border-left:3px solid #2196f3;">' + 
                    l.text + 
                    '</div>'
                ).join('');
            });
        }

        console.log('‚úÖ –ì—Ä–∞ –≥–æ—Ç–æ–≤–∞!');
    </script>
</body>
</html>
