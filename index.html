<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–Ω–æ–ø–æ–ª—ñ—è –£–∫—Ä–∞—ó–Ω–∞ üá∫üá¶</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body style="font-family:Arial;background:#e3f2fd;padding:20px;">
    <div style="max-width:500px;margin:0 auto;background:white;padding:30px;border-radius:15px;">
        <h1 style="text-align:center;color:#1565c0;">üá∫üá¶ –ú–æ–Ω–æ–ø–æ–ª—ñ—è –£–∫—Ä–∞—ó–Ω–∞ - –û–Ω–ª–∞–π–Ω</h1>
        
        <div id="status" style="padding:15px;background:#fff3e0;border-radius:8px;text-align:center;margin:20px 0;">
            –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...
        </div>
        
        <div id="lobby" style="display:none;">
            <input type="text" id="playerName" placeholder="–í–∞—à–µ —ñ–º'—è" value="–ì—Ä–∞–≤–µ—Ü—å" style="width:100%;padding:15px;margin:10px 0;border:2px solid #ddd;border-radius:8px;font-size:16px;">
            
            <button onclick="createRoom()" style="width:100%;padding:15px;margin:10px 0;background:#4caf50;color:white;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;">
                üéØ –°—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É
            </button>
            
            <div style="text-align:center;margin:15px 0;color:#666;">‚Äî –ê–ë–û ‚Äî</div>
            
            <input type="text" id="roomCode" placeholder="–ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏" style="width:100%;padding:15px;margin:10px 0;border:2px solid #ddd;border-radius:8px;font-size:16px;text-transform:uppercase;">
            
            <button onclick="joinRoom()" style="width:100%;padding:15px;margin:10px 0;background:#2196f3;color:white;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;">
                üö™ –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è
            </button>
            
            <div id="waiting" style="display:none;">
                <div style="background:#f5f5f5;padding:20px;border-radius:8px;text-align:center;margin:20px 0;">
                    <div style="font-size:0.9rem;margin-bottom:10px;">üìã –ö–æ–¥:</div>
                    <div id="codeDisplay" style="font-size:2rem;font-weight:bold;color:#1565c0;letter-spacing:3px;"></div>
                </div>
                
                <div id="playersList" style="background:#f9f9f9;padding:15px;border-radius:8px;margin:15px 0;"></div>
                
                <button onclick="startGame()" id="startBtn" disabled style="width:100%;padding:15px;background:#ff9800;color:white;border:none;border-radius:8px;font-size:18px;font-weight:bold;cursor:pointer;">
                    –û—á—ñ–∫—É–≤–∞–Ω–Ω—è...
                </button>
            </div>
        </div>
        
        <div id="game" style="display:none;">
            <div style="background:#1565c0;color:white;padding:12px 20px;border-radius:8px;margin-bottom:15px;">
                <div>üéÆ –ö—ñ–º–Ω–∞—Ç–∞: <span id="gameCode"></span></div>
            </div>
            <div id="gamePlayers"></div>
            <button onclick="rollDice()" id="rollBtn" style="width:100%;padding:15px;background:#2196f3;color:white;border:none;border-radius:8px;font-size:16px;font-weight:bold;margin:10px 0;cursor:pointer;">
                üé≤ –ö–∏–Ω—É—Ç–∏ –∫—É–±–∏–∫–∏
            </button>
            <div id="gameLog" style="background:#f9f9f9;padding:15px;border-radius:8px;max-height:150px;overflow-y:auto;"></div>
        </div>
    </div>

    <script>
        const config = {
            apiKey: "AIzaSyByYh0VOBkFvPcQYRzabrt8sfj32gpbsWQ",
            authDomain: "monopoly-ukraine.firebaseapp.com",
            databaseURL: "https://monopoly-ukraine-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "monopoly-ukraine",
            storageBucket: "monopoly-ukraine.firebasestorage.app",
            messagingSenderId: "1046709502750",
            appId: "1:1046709502750:web:ba8ad3c1f11780d1a6bf0f"
        };

        let db;
        try {
            firebase.initializeApp(config);
            db = firebase.database();
            
            db.ref('.info/connected').on('value', snap => {
                const status = document.getElementById('status');
                if (snap.val()) {
                    status.innerHTML = '‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ!';
                    status.style.background = '#e8f5e9';
                    setTimeout(() => {
                        status.style.display = 'none';
                        document.getElementById('lobby').style.display = 'block';
                    }, 1500);
                }
            });
        } catch(e) {
            document.getElementById('status').innerHTML = '‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message;
            document.getElementById('status').style.background = '#ffebee';
        }

        const myId = 'p' + Date.now();
        let myRoom = null;
        let myName = null;

        function generateCode() {
            return 'GAME-' + Math.random().toString(36).substr(2, 4).toUpperCase();
        }

        async function createRoom() {
            myName = document.getElementById('playerName').value.trim() || '–ì—Ä–∞–≤–µ—Ü—å';
            myRoom = generateCode();

            await db.ref('rooms/' + myRoom).set({
                status: 'waiting',
                players: {
                    [myId]: { id: myId, name: myName, pos: 0, money: 15000, online: true }
                },
                game: { current: 0, dice1: 1, dice2: 1 }
            });

            document.getElementById('codeDisplay').textContent = myRoom;
            document.getElementById('waiting').style.display = 'block';
            
            listen();
        }

        async function joinRoom() {
            myName = document.getElementById('playerName').value.trim() || '–ì—Ä–∞–≤–µ—Ü—å';
            myRoom = document.getElementById('roomCode').value.trim().toUpperCase();

            if (!myRoom) {
                alert('–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥!');
                return;
            }

            const snap = await db.ref('rooms/' + myRoom).once('value');
            if (!snap.val()) {
                alert('–ö—ñ–º–Ω–∞—Ç—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
                return;
            }

            await db.ref('rooms/' + myRoom + '/players/' + myId).set({
                id: myId, name: myName, pos: 0, money: 15000, online: true
            });

            document.getElementById('codeDisplay').textContent = myRoom;
            document.getElementById('waiting').style.display = 'block';
            
            listen();
        }

        function listen() {
            db.ref('rooms/' + myRoom).on('value', snap => {
                const room = snap.val();
                if (!room) return;

                if (room.status === 'waiting') {
                    const players = Object.values(room.players || {});
                    document.getElementById('playersList').innerHTML = players.map(p => 
                        '<div style="padding:10px;margin:5px 0;background:white;border-radius:6px;border-left:4px solid #4caf50;">' + 
                        p.name + (p.online ? ' üü¢' : ' üî¥') + '</div>'
                    ).join('');

                    const btn = document.getElementById('startBtn');
                    btn.disabled = players.length < 2;
                    btn.textContent = '–ü–æ—á–∞—Ç–∏ –≥—Ä—É (' + players.length + ' –≥—Ä–∞–≤—Ü—ñ–≤)';
                } else if (room.status === 'playing') {
                    showGame(room);
                }
            });
        }

        async function startGame() {
            await db.ref('rooms/' + myRoom).update({ status: 'playing' });
        }

        function showGame(room) {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            document.getElementById('gameCode').textContent = myRoom;

            const players = Object.values(room.players || {});
            document.getElementById('gamePlayers').innerHTML = players.map((p, i) => 
                '<div style="padding:10px;margin:5px 0;background:' + 
                (i === room.game.current ? '#e3f2fd' : 'white') + 
                ';border-radius:6px;border:2px solid ' + 
                (i === room.game.current ? '#2196f3' : '#ddd') + ';">' +
                '<strong>' + p.name + (p.id === myId ? ' (–í–∏)' : '') + '</strong><br>' +
                '–ì—Ä–æ—à—ñ: ' + p.money + '‚Ç¥' +
                '</div>'
            ).join('');

            const btn = document.getElementById('rollBtn');
            const isMyTurn = players[room.game.current].id === myId;
            btn.disabled = !isMyTurn;
            btn.textContent = isMyTurn ? 'üé≤ –í–∞—à —Ö—ñ–¥' : '‚è≥ –ß–µ–∫–∞–π—Ç–µ...';
        }

        async function rollDice() {
            const snap = await db.ref('rooms/' + myRoom).once('value');
            const room = snap.val();
            const players = Object.values(room.players);
            
            if (players[room.game.current].id !== myId) {
                alert('–ù–µ –≤–∞—à —Ö—ñ–¥!');
                return;
            }

            const d1 = Math.floor(Math.random() * 6) + 1;
            const d2 = Math.floor(Math.random() * 6) + 1;

            await db.ref('rooms/' + myRoom + '/game').update({ 
                dice1: d1, 
                dice2: d2,
                current: (room.game.current + 1) % players.length
            });

            const log = myName + ' –≤–∏–∫–∏–Ω—É–≤ ' + d1 + '+' + d2;
            await db.ref('rooms/' + myRoom + '/logs').push({ text: log, time: Date.now() });
        }

        console.log('‚úÖ –ì–æ—Ç–æ–≤–æ!');
    </script>
</body>
</html>
