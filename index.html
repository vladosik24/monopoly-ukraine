<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ú–æ–Ω–æ–ø–æ–ª—ñ—è –£–∫—Ä–∞—ó–Ω–∞ üá∫üá¶</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1565c0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #e3f2fd; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 450px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
        .mode-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .mode-card { padding: 20px; border: 3px solid #ddd; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s; background: white; }
        .mode-card:hover { border-color: #2196f3; transform: scale(1.05); }
        .mode-card.selected { border-color: #2196f3; background: #e3f2fd; }
        .mode-icon { font-size: 3rem; margin-bottom: 10px; }
        button { padding: 12px 24px; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .btn-primary { background: #2196f3; color: white; width: 100%; margin-top: 15px; }
        .btn-primary:hover { background: #1976d2; }
        .btn-success { background: #4caf50; color: white; }
        .btn-success:hover { background: #45a049; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        input:focus { outline: none; border-color: #2196f3; }
        .board-container { max-width: 800px; margin: 10px auto; padding: 10px; background: white; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .board { width: 100%; aspect-ratio: 1; display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); gap: 0; background: #d4e6d4; border: 2px solid #2c5f2d; position: relative; max-height: 85vh; }
        .cell { border: 1px solid #2c5f2d; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 0.7rem; font-weight: bold; text-align: center; padding: 4px; position: relative; background: white; }
        .corner { font-size: 0.8rem; }
        .color-bar { width: 100%; height: 20%; position: absolute; top: 0; left: 0; }
        .price { font-size: 0.6rem; color: #666; margin-top: 2px; }
        .players-on-cell { position: absolute; bottom: 2px; display: flex; gap: 2px; flex-wrap: wrap; justify-content: center; }
        .player-token { width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .info-panel { margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 10px; }
        .player-card { padding: 12px; margin: 8px 0; background: white; border-radius: 8px; border-left: 6px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .player-card.active { background: #e3f2fd; border-left-width: 8px; }
        .team-badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 0.8rem; margin-left: 5px; color: white; }
        .bot-badge { background: #9c27b0; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 5px; }
        @media (max-width: 768px) {
            .board-container { padding: 5px; margin: 5px; }
            .board { max-height: 70vh; }
            .cell { font-size: 0.45rem; padding: 1px; }
            .corner { font-size: 0.5rem; }
            .mode-selector { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="modeSelect" class="modal" style="display: flex;">
        <div class="modal-content">
            <h2 style="text-align: center; color: #1565c0; margin-bottom: 20px;">üá∫üá¶ –ú–æ–Ω–æ–ø–æ–ª—ñ—è –£–∫—Ä–∞—ó–Ω–∞</h2>
            <div id="status" style="padding: 12px; background: #fff3e0; border-radius: 8px; text-align: center; margin-bottom: 15px;">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</div>
            
            <div id="modeSelection" style="display: none;">
                <h3 style="margin-bottom: 15px; text-align: center;">–û–±–µ—Ä—ñ—Ç—å —Ä–µ–∂–∏–º –≥—Ä–∏:</h3>
                <div class="mode-selector">
                    <div class="mode-card" onclick="selectMode('classic')">
                        <div class="mode-icon">üé≤</div>
                        <h4>–ö–ª–∞—Å–∏—á–Ω–∏–π</h4>
                        <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">2-4 –≥—Ä–∞–≤—Ü—ñ</p>
                    </div>
                    <div class="mode-card" onclick="selectMode('teams')">
                        <div class="mode-icon">üë•</div>
                        <h4>–ö–æ–º–∞–Ω–¥–∏ 2√ó2</h4>
                        <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">4 –≥—Ä–∞–≤—Ü—ñ</p>
                    </div>
                    <div class="mode-card" onclick="selectMode('vsbot')">
                        <div class="mode-icon">ü§ñ</div>
                        <h4>–ü—Ä–æ—Ç–∏ –±–æ—Ç–∞</h4>
                        <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">1 vs 1-3 –±–æ—Ç–∏</p>
                    </div>
                    <div class="mode-card" onclick="selectMode('mixed')">
                        <div class="mode-icon">üéØ</div>
                        <h4>–ó–º—ñ—à–∞–Ω–∏–π</h4>
                        <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">–ì—Ä–∞–≤—Ü—ñ + –±–æ—Ç–∏</p>
                    </div>
                </div>
                
                <div id="playerNameInput" style="display: none;">
                    <input type="text" id="playerName" placeholder="–í–∞—à–µ —ñ–º'—è" value="–ì—Ä–∞–≤–µ—Ü—å">
                    <div id="botCountSelector" style="display: none; margin: 15px 0;">
                        <label style="display: block; margin-bottom: 10px; font-weight: bold;">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –±–æ—Ç—ñ–≤:</label>
                        <select id="botCount" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                            <option value="1">1 –±–æ—Ç</option>
                            <option value="2">2 –±–æ—Ç–∏</option>
                            <option value="3">3 –±–æ—Ç–∏</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="createRoomWithMode()">üéØ –°—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É</button>
                    <div style="text-align: center; margin: 15px 0; color: #666; font-weight: bold;">‚Äî –ê–ë–û ‚Äî</div>
                    <input type="text" id="roomCode" placeholder="–ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏" style="text-transform: uppercase;">
                    <button class="btn-primary" onclick="joinRoom()">üö™ –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</button>
                </div>
            </div>
            
            <div id="waiting" style="display: none;">
                <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; text-align: center; margin: 20px 0;">
                    <div style="font-size: 0.9rem; margin-bottom: 10px; color: #666;">üìã –ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏:</div>
                    <div id="codeDisplay" style="font-size: 2rem; font-weight: bold; color: #1565c0; letter-spacing: 3px;"></div>
                    <div id="modeDisplay" style="margin-top: 10px; color: #666; font-size: 0.9rem;"></div>
                </div>
                <div id="playersList"></div>
                <button class="btn-success" onclick="startGame()" id="startBtn" disabled style="width: 100%; margin-top: 15px;">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</button>
            </div>
        </div>
    </div>

    <div id="gameContainer" style="display: none;">
        <div class="board-container">
            <div style="text-align: center; margin-bottom: 10px;">
                <h2 style="color: #1565c0; font-size: 1.5rem;">üá∫üá¶ –ú–æ–Ω–æ–ø–æ–ª—ñ—è</h2>
                <div style="color: #666; font-size: 0.85rem;">–ö—ñ–º–Ω–∞—Ç–∞: <span id="gameCode"></span> | <span id="gameModeDisplay"></span></div>
            </div>
            <div class="board" id="board"></div>
            <div class="info-panel">
                <div id="diceResult" style="font-size: 2.5rem; text-align: center; margin: 10px 0;"></div>
                <div id="gamePlayers"></div>
                <button class="btn-primary" onclick="rollDice()" id="rollBtn" style="width: 100%; margin: 10px 0;">üé≤ –ö–∏–Ω—É—Ç–∏ –∫—É–±–∏–∫–∏</button>
                <div id="propertyInfo"></div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            const scripts = [
                { app: 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js', db: 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js' },
                { app: 'https://cdn.jsdelivr.net/npm/firebase@10.7.0/firebase-app-compat.js', db: 'https://cdn.jsdelivr.net/npm/firebase@10.7.0/firebase-database-compat.js' }
            ];
            function loadFirebase(index) {
                if (index >= scripts.length) { document.getElementById('status').innerHTML = '‚ùå Firebase –ø–æ–º–∏–ª–∫–∞'; return; }
                const script1 = document.createElement('script');
                script1.src = scripts[index].app;
                script1.onerror = () => loadFirebase(index + 1);
                script1.onload = () => {
                    const script2 = document.createElement('script');
                    script2.src = scripts[index].db;
                    script2.onerror = () => loadFirebase(index + 1);
                    script2.onload = () => initApp();
                    document.body.appendChild(script2);
                };
                document.body.appendChild(script1);
            }
            loadFirebase(0);
        })();

        const config = { apiKey: "AIzaSyByYh0VOBkFvPcQYRzabrt8sfj32gpbsWQ", authDomain: "monopoly-ukraine.firebaseapp.com", databaseURL: "https://monopoly-ukraine-default-rtdb.europe-west1.firebasedatabase.app", projectId: "monopoly-ukraine", storageBucket: "monopoly-ukraine.firebasestorage.app", messagingSenderId: "1046709502750", appId: "1:1046709502750:web:ba8ad3c1f11780d1a6bf0f" };
        const COLORS = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#A8E6CF'];
        const COLOR_NAMES = ['üî¥ –ß–µ—Ä–≤–æ–Ω–∏–π', 'üîµ –ë–ª–∞–∫–∏—Ç–Ω–∏–π', 'üü° –ñ–æ–≤—Ç–∏–π', 'üü¢ –ó–µ–ª–µ–Ω–∏–π'];
        const TEAM_COLORS = { red: '#e53935', blue: '#1e88e5' };
        const PROPERTIES = [
            { name: '–°–¢–ê–†–¢', type: 'corner', pos: 0 }, { name: '–õ—É—Ü—å–∫', price: 600, color: '#8B4513', pos: 1 }, { name: '–®–∞–Ω—Å', type: 'chance', pos: 2 }, { name: '–†—ñ–≤–Ω–µ', price: 600, color: '#8B4513', pos: 3 }, { name: '–ü–æ–¥–∞—Ç–æ–∫', type: 'tax', amount: 2000, pos: 4 }, { name: '–í–æ–∫–∑–∞–ª –ö–∏—ó–≤', price: 2000, type: 'station', pos: 5 }, { name: '–ñ–∏—Ç–æ–º–∏—Ä', price: 1000, color: '#87CEEB', pos: 6 }, { name: '–®–∞–Ω—Å', type: 'chance', pos: 7 }, { name: '–ß–µ—Ä–Ω—ñ–≥—ñ–≤', price: 1000, color: '#87CEEB', pos: 8 }, { name: '–°—É–º–∏', price: 1200, color: '#87CEEB', pos: 9 }, { name: '–í\'–Ø–ó–ù–ò–¶–Ø', type: 'corner', pos: 10 }, { name: '–ü–æ–ª—Ç–∞–≤–∞', price: 1400, color: '#FF69B4', pos: 11 }, { name: '–ï–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü—ñ—è', price: 1500, type: 'utility', pos: 12 }, { name: '–ß–µ—Ä–∫–∞—Å–∏', price: 1400, color: '#FF69B4', pos: 13 }, { name: '–ö—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π', price: 1600, color: '#FF69B4', pos: 14 }, { name: '–í–æ–∫–∑–∞–ª –õ—å–≤—ñ–≤', price: 2000, type: 'station', pos: 15 }, { name: '–í—ñ–Ω–Ω–∏—Ü—è', price: 1800, color: '#FFA500', pos: 16 }, { name: '–®–∞–Ω—Å', type: 'chance', pos: 17 }, { name: '–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π', price: 1800, color: '#FFA500', pos: 18 }, { name: '–¢–µ—Ä–Ω–æ–ø—ñ–ª—å', price: 2000, color: '#FFA500', pos: 19 }, { name: '–ü–ê–†–ö–û–í–ö–ê', type: 'corner', pos: 20 }, { name: '–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫', price: 2200, color: '#FF0000', pos: 21 }, { name: '–®–∞–Ω—Å', type: 'chance', pos: 22 }, { name: '–ß–µ—Ä–Ω—ñ–≤—Ü—ñ', price: 2200, color: '#FF0000', pos: 23 }, { name: '–£–∂–≥–æ—Ä–æ–¥', price: 2400, color: '#FF0000', pos: 24 }, { name: '–í–æ–∫–∑–∞–ª –û–¥–µ—Å–∞', price: 2000, type: 'station', pos: 25 }, { name: '–õ—å–≤—ñ–≤', price: 2600, color: '#FFFF00', pos: 26 }, { name: '–ú–∏–∫–æ–ª–∞—ó–≤', price: 2600, color: '#FFFF00', pos: 27 }, { name: '–í–æ–¥–æ–∫–∞–Ω–∞–ª', price: 1500, type: 'utility', pos: 28 }, { name: '–•–µ—Ä—Å–æ–Ω', price: 2800, color: '#FFFF00', pos: 29 }, { name: '–ü–û–õ–Ü–¶–Ü–Ø', type: 'corner', pos: 30 }, { name: '–ó–∞–ø–æ—Ä—ñ–∂–∂—è', price: 3000, color: '#00FF00', pos: 31 }, { name: '–î–Ω—ñ–ø—Ä–æ', price: 3000, color: '#00FF00', pos: 32 }, { name: '–®–∞–Ω—Å', type: 'chance', pos: 33 }, { name: '–ö—Ä–∏–≤–∏–π –†—ñ–≥', price: 3200, color: '#00FF00', pos: 34 }, { name: '–í–æ–∫–∑–∞–ª –•–∞—Ä–∫—ñ–≤', price: 2000, type: 'station', pos: 35 }, { name: '–®–∞–Ω—Å', type: 'chance', pos: 36 }, { name: '–•–∞—Ä–∫—ñ–≤', price: 3500, color: '#0000FF', pos: 37 }, { name: '–ü–æ–¥–∞—Ç–æ–∫', type: 'tax', amount: 1000, pos: 38 }, { name: '–ö–∏—ó–≤', price: 4000, color: '#0000FF', pos: 39 }
        ];

        let db, myId = 'p' + Date.now(), myRoom = null, myName = null, selectedMode = null;

        function initApp() {
            if (typeof firebase === 'undefined') return;
            firebase.initializeApp(config); db = firebase.database();
            db.ref('.info/connected').on('value', snap => {
                if (snap.val()) {
                    document.getElementById('status').innerHTML = '‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ!';
                    document.getElementById('status').style.background = '#e8f5e9';
                    setTimeout(() => { document.getElementById('status').style.display = 'none'; document.getElementById('modeSelection').style.display = 'block'; }, 1000);
                }
            });
        }

        function selectMode(mode) {
            selectedMode = mode;
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
            event.target.closest('.mode-card').classList.add('selected');
            document.getElementById('playerNameInput').style.display = 'block';
            document.getElementById('botCountSelector').style.display = (mode === 'vsbot' || mode === 'mixed') ? 'block' : 'none';
        }

        function generateCode() { return 'GAME-' + Math.random().toString(36).substr(2, 4).toUpperCase(); }

        async function createRoomWithMode() {
            if (!selectedMode) return alert('–û–±–µ—Ä—ñ—Ç—å —Ä–µ–∂–∏–º –≥—Ä–∏!');
            myName = document.getElementById('playerName').value.trim() || '–ì—Ä–∞–≤–µ—Ü—å';
            myRoom = generateCode();

            const roomData = {
                code: myRoom,
                mode: selectedMode,
                status: 'waiting',
                players: {},
                game: { current: 0, dice1: 0, dice2: 0 }
            };

            // –î–æ–¥–∞—î–º–æ –≥—Ä–∞–≤—Ü—è
            roomData.players[myId] = { 
                id: myId, name: myName, pos: 0, money: 15000, props: [], 
                online: true, color: COLORS[0], colorName: COLOR_NAMES[0], isBot: false
            };

            // –î–æ–¥–∞—î–º–æ –∫–æ–º–∞–Ω–¥–∏ –¥–ª—è —Ä–µ–∂–∏–º—É 2√ó2
            if (selectedMode === 'teams') {
                roomData.teams = { red: [myId], blue: [] };
                roomData.players[myId].team = 'red';
            }

            // –î–æ–¥–∞—î–º–æ –±–æ—Ç—ñ–≤
            if (selectedMode === 'vsbot' || selectedMode === 'mixed') {
                const botCount = parseInt(document.getElementById('botCount').value);
                for (let i = 0; i < botCount; i++) {
                    const botId = 'bot_' + i;
                    roomData.players[botId] = {
                        id: botId, name: '–ë–æ—Ç ' + (i + 1), pos: 0, money: 15000, props: [],
                        online: true, color: COLORS[i + 1], colorName: COLOR_NAMES[i + 1], isBot: true
                    };
                }
            }

            await db.ref('rooms/' + myRoom).set(roomData);
            document.getElementById('codeDisplay').textContent = myRoom;
            const modeNames = { classic: 'üé≤ –ö–ª–∞—Å–∏—á–Ω–∏–π', teams: 'üë• –ö–æ–º–∞–Ω–¥–∏ 2√ó2', vsbot: 'ü§ñ –ü—Ä–æ—Ç–∏ –±–æ—Ç–∞', mixed: 'üéØ –ó–º—ñ—à–∞–Ω–∏–π' };
            document.getElementById('modeDisplay').textContent = '–†–µ–∂–∏–º: ' + modeNames[selectedMode];
            document.getElementById('waiting').style.display = 'block';
            document.getElementById('modeSelection').style.display = 'none';
            listen();
        }

        async function joinRoom() {
            myName = document.getElementById('playerName').value.trim() || '–ì—Ä–∞–≤–µ—Ü—å';
            myRoom = document.getElementById('roomCode').value.trim().toUpperCase();
            if (!myRoom) return alert('–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥!');
            const snap = await db.ref('rooms/' + myRoom).once('value');
            if (!snap.val()) return alert('–ö—ñ–º–Ω–∞—Ç—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
            const room = snap.val();
            const players = Object.values(room.players || {});
            if (players.length >= 4) return alert('–ö—ñ–º–Ω–∞—Ç–∞ –ø–æ–≤–Ω–∞!');

            const newPlayer = { id: myId, name: myName, pos: 0, money: 15000, props: [], online: true, color: COLORS[players.length], colorName: COLOR_NAMES[players.length], isBot: false };
            
            if (room.mode === 'teams') {
                const redCount = Object.values(room.players).filter(p => p.team === 'red').length;
                newPlayer.team = redCount < 2 ? 'red' : 'blue';
                await db.ref('rooms/' + myRoom + '/teams/' + newPlayer.team).set([...room.teams[newPlayer.team], myId]);
            }

            await db.ref('rooms/' + myRoom + '/players/' + myId).set(newPlayer);
            document.getElementById('codeDisplay').textContent = myRoom;
            document.getElementById('waiting').style.display = 'block';
            document.getElementById('modeSelection').style.display = 'none';
            listen();
        }

        function listen() {
            db.ref('rooms/' + myRoom).on('value', snap => {
                const room = snap.val(); if (!room) return;
                if (room.status === 'waiting') {
                    const players = Object.values(room.players || {});
                    let html = players.map(p => {
                        let badge = p.isBot ? '<span class="bot-badge">ü§ñ –ë–û–¢</span>' : '';
                        if (room.mode === 'teams' && p.team) {
                            badge += `<span class="team-badge" style="background: ${TEAM_COLORS[p.team]}">${p.team === 'red' ? '–ß–µ—Ä–≤–æ–Ω–∞' : '–°–∏–Ω—è'}</span>`;
                        }
                        return `<div style="padding:10px;margin:5px 0;background:white;border-radius:6px;border-left:4px solid ${p.color};"><strong>${p.name}</strong> ${p.colorName} ${badge}</div>`;
                    }).join('');
                    document.getElementById('playersList').innerHTML = html;
                    const btn = document.getElementById('startBtn');
                    const minPlayers = room.mode === 'teams' ? 4 : (room.mode === 'vsbot' ? 1 : 2);
                    btn.disabled = players.length < minPlayers;
                    btn.textContent = `–ü–æ—á–∞—Ç–∏ –≥—Ä—É (${players.length} –≥—Ä–∞–≤—Ü—ñ–≤)`;
                } else if (room.status === 'playing') {
                    showGame(room);
                }
            });
        }

        async function startGame() {
            await db.ref('rooms/' + myRoom).update({ status: 'playing' });
        }

        function showGame(room) {
            document.getElementById('modeSelect').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
            document.getElementById('gameCode').textContent = myRoom;
            const modeNames = { classic: 'üé≤ –ö–ª–∞—Å–∏—á–Ω–∏–π', teams: 'üë• –ö–æ–º–∞–Ω–¥–∏', vsbot: 'ü§ñ –ü—Ä–æ—Ç–∏ –±–æ—Ç–∞', mixed: 'üéØ –ó–º—ñ—à–∞–Ω–∏–π' };
            document.getElementById('gameModeDisplay').textContent = modeNames[room.mode];
            drawBoard();
            updatePlayers(room);
        }

        function drawBoard() {
            const board = document.getElementById('board'); board.innerHTML = '';
            const positions = [ ...Array(11).fill(0).map((_, i) => [10, i]), ...Array(9).fill(0).map((_, i) => [9-i, 10]), ...Array(9).fill(0).map((_, i) => [0, 9-i]), ...Array(9).fill(0).map((_, i) => [i+1, 0]) ];
            positions.forEach(([row, col], idx) => {
                const cell = document.createElement('div'); cell.className = 'cell'; cell.id = 'cell-' + idx; cell.style.gridRow = row + 1; cell.style.gridColumn = col + 1;
                const prop = PROPERTIES[idx];
                if (prop.type === 'corner') { cell.classList.add('corner'); cell.innerHTML = `<div>${prop.name}</div>`; }
                else if (prop.color) { cell.innerHTML = `<div class="color-bar" style="background: ${prop.color}"></div><div style="margin-top: 20%;">${prop.name}</div><div class="price">${prop.price}‚Ç¥</div>`; }
                else { cell.innerHTML = `<div>${prop.name}</div>`; }
                board.appendChild(cell);
            });
        }

        function updatePlayers(room) {
            const players = Object.values(room.players || {});
            document.querySelectorAll('.players-on-cell').forEach(el => el.remove());
            players.forEach(p => {
                const cell = document.getElementById('cell-' + p.pos);
                if (cell) {
                    let container = cell.querySelector('.players-on-cell');
                    if (!container) { container = document.createElement('div'); container.className = 'players-on-cell'; cell.appendChild(container); }
                    const token = document.createElement('div'); token.className = 'player-token'; token.style.background = p.color; container.appendChild(token);
                }
            });
            
            document.getElementById('gamePlayers').innerHTML = players.map((p, i) => {
                let badge = p.isBot ? '<span class="bot-badge">ü§ñ</span>' : '';
                return `<div class="player-card ${i === room.game.current ? 'active' : ''}" style="border-left-color: ${p.color}"><div><strong>${p.name}${p.id === myId ? ' (–í–∏)' : ''}</strong> ${badge}<br><small>${p.colorName}</small></div><div style="text-align: right;"><div style="font-size: 1.2rem; font-weight: bold; color: #4caf50;">${p.money}‚Ç¥</div><small>–ü–æ–∑–∏—Ü—ñ—è: ${p.pos}</small></div></div>`;
            }).join('');

            const btn = document.getElementById('rollBtn');
            const currentPlayer = players[room.game.current];
            const isMyTurn = currentPlayer.id === myId;
            btn.disabled = !isMyTurn;
            btn.textContent = isMyTurn ? 'üé≤ –í–∞—à —Ö—ñ–¥' : '‚è≥ –ß–µ–∫–∞–π—Ç–µ...';

            if (room.game.dice1) {
                document.getElementById('diceResult').innerHTML = `üé≤ ${room.game.dice1} + ${room.game.dice2} = ${room.game.dice1 + room.game.dice2}`;
            }

            // –ê–≤—Ç–æ—Ö—ñ–¥ –±–æ—Ç–∞
            if (currentPlayer.isBot && room.status === 'playing') {
                setTimeout(() => botMove(room), 1500);
            }

            const currentPos = currentPlayer.pos; const prop = PROPERTIES[currentPos];
            if (prop.price && isMyTurn) {
                const owned = players.find(pl => pl.props && pl.props.includes(currentPos));
                if (!owned) {
                    document.getElementById('propertyInfo').innerHTML = `<div class="property-card"><h3 style="color: ${prop.color};">${prop.name}</h3><p style="font-size: 1.2rem; font-weight: bold;">–¶—ñ–Ω–∞: ${prop.price}‚Ç¥</p><button class="btn-success" onclick="buyProperty(${currentPos}, ${prop.price})" style="width: 100%; margin-top: 10px;">üí∞ –ö—É–ø–∏—Ç–∏</button></div>`;
                } else {
                    document.getElementById('propertyInfo').innerHTML = `<div class="property-card" style="border-color: ${owned.color};"><h3>${prop.name}</h3><p>–í–ª–∞—Å–Ω–∏–∫: <strong>${owned.name}</strong></p></div>`;
                }
            } else { document.getElementById('propertyInfo').innerHTML = ''; }
        }

        async function botMove(room) {
            const players = Object.values(room.players);
            const currentPlayer = players[room.game.current];
            if (!currentPlayer.isBot) return;

            // –ë–æ—Ç –∫–∏–¥–∞—î –∫—É–±–∏–∫–∏
            const d1 = Math.floor(Math.random() * 6) + 1;
            const d2 = Math.floor(Math.random() * 6) + 1;
            const newPos = (currentPlayer.pos + d1 + d2) % 40;

            await db.ref('rooms/' + myRoom + '/players/' + currentPlayer.id).update({ pos: newPos });
            await db.ref('rooms/' + myRoom + '/game').update({ 
                dice1: d1, dice2: d2,
                current: (room.game.current + 1) % players.length
            });

            // –ë–æ—Ç –ø—Ä–∏–π–º–∞—î —Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ –∫—É–ø—ñ–≤–ª—é
            setTimeout(async () => {
                const prop = PROPERTIES[newPos];
                if (prop.price && currentPlayer.money >= prop.price) {
                    const owned = players.find(pl => pl.props && pl.props.includes(newPos));
                    if (!owned) {
                        // –ë–æ—Ç –∫—É–ø—É—î —è–∫—â–æ —î –≥—Ä–æ—à—ñ —Ç–∞ —Ü—ñ–Ω–∞ –º–µ–Ω—à–∞ –∑–∞ 70% –±—é–¥–∂–µ—Ç—É
                        if (prop.price < currentPlayer.money * 0.7) {
                            const newProps = [...(currentPlayer.props || []), newPos];
                            const newMoney = currentPlayer.money - prop.price;
                            await db.ref('rooms/' + myRoom + '/players/' + currentPlayer.id).update({
                                props: newProps,
                                money: newMoney
                            });
                            console.log(`ü§ñ ${currentPlayer.name} –∫—É–ø–∏–≤ ${prop.name} –∑–∞ ${prop.price}‚Ç¥`);
                        }
                    }
                }
            }, 1000);
        }

        async function buyProperty(pos, price) {
            const snap = await db.ref('rooms/' + myRoom).once('value');
            const room = snap.val();
            const players = Object.values(room.players);
            const currentPlayer = players[room.game.current];
            if (currentPlayer.id !== myId) return;
            if (currentPlayer.money < price) return alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –≥—Ä–æ—à–µ–π!');

            const newProps = [...(currentPlayer.props || []), pos];
            const newMoney = currentPlayer.money - price;

            // –î–ª—è —Ä–µ–∂–∏–º—É –∫–æ–º–∞–Ω–¥ - –æ–Ω–æ–≤–ª—é—î–º–æ —Å–ø—ñ–ª—å–Ω–∏–π –±—é–¥–∂–µ—Ç
            if (room.mode === 'teams') {
                const team = currentPlayer.team;
                const teamPlayers = players.filter(p => p.team === team);
                for (let p of teamPlayers) {
                    await db.ref('rooms/' + myRoom + '/players/' + p.id).update({ money: newMoney });
                }
            }

            await db.ref('rooms/' + myRoom + '/players/' + myId).update({
                props: newProps,
                money: newMoney
            });
        }

        async function rollDice() {
            const snap = await db.ref('rooms/' + myRoom).once('value');
            const room = snap.val();
            const players = Object.values(room.players);
            if (players[room.game.current].id !== myId) return alert('–ù–µ –≤–∞—à —Ö—ñ–¥!');

            const d1 = Math.floor(Math.random() * 6) + 1;
            const d2 = Math.floor(Math.random() * 6) + 1;
            const currentPlayer = players[room.game.current];
            const newPos = (currentPlayer.pos + d1 + d2) % 40;

            await db.ref('rooms/' + myRoom + '/players/' + currentPlayer.id).update({ pos: newPos });
            await db.ref('rooms/' + myRoom + '/game').update({ 
                dice1: d1, dice2: d2,
                current: (room.game.current + 1) % players.length
            });
        }
    </script>
</body>
</html>