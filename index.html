<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ú–æ–Ω–æ–ø–æ–ª—ñ—è –£–∫—Ä–∞—ó–Ω–∞ üá∫üá¶</title>
<link rel="manifest" href="./manifest.json">
<link rel="icon" href="./icon-192.png" sizes="192x192">
<style>
/* --- –ë–∞–∑–æ–≤—ñ —Å—Ç–∏–ª—ñ --- */
body { font-family: Arial, sans-serif; background:#f2f2f2; margin:0; padding:0;}
.container { max-width:480px; margin:auto; padding:10px; }
button { padding:10px 20px; margin:5px; font-size:16px; cursor:pointer;}
input { width:100%; padding:10px; margin:5px 0;}
#log { height:150px; overflow-y:scroll; border:1px solid #ccc; background:#fff; padding:5px;}
.hidden { display:none; }
</style>
</head>
<body>
<div class="container">
<h1>üá∫üá¶ –ú–æ–Ω–æ–ø–æ–ª—ñ—è –£–∫—Ä–∞—ó–Ω–∞ - –û–Ω–ª–∞–π–Ω</h1>

<!-- –õ–æ–±—ñ -->
<div id="lobbyScreen">
    <div id="connectionStatus">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</div>
    <div id="lobbyContent" class="hidden">
        <input type="text" id="playerName" placeholder="–í–∞—à–µ —ñ–º'—è" value="–ì—Ä–∞–≤–µ—Ü—å">
        <button onclick="createRoom()">–°—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É</button>
        <div style="text-align:center;">–∞–±–æ</div>
        <input type="text" id="roomCodeInput" placeholder="–ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏">
        <button onclick="joinRoom()">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</button>
        <div id="waitingRoom" class="hidden">
            <div>–ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏: <span id="roomCodeDisplay"></span></div>
            <div id="playersList"></div>
            <button id="startGameBtn" onclick="startGame()" disabled>–ü–æ—á–∞—Ç–∏ –≥—Ä—É</button>
        </div>
    </div>
</div>

<!-- –ì—Ä–∞ -->
<div id="gameScreen" class="hidden">
    <div>–ö—ñ–º–Ω–∞—Ç–∞: <span id="gameRoomCode"></span></div>
    <div id="onlineCount">0 –æ–Ω–ª–∞–π–Ω</div>
    <button onclick="rollDice()">üé≤ –ö–∏–Ω—É—Ç–∏ –∫—É–±–∏–∫–∏</button>
    <button onclick="leaveGame()">üö™ –í–∏–π—Ç–∏</button>
    <div id="log"></div>
</div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, set, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseConfig = {
    apiKey: "AIzaSyByYh0VOBkFvPcQYRzabrt8sfj32gpbsWQ",
    authDomain: "monopoly-ukraine.firebaseapp.com",
    databaseURL: "https://monopoly-ukraine-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "monopoly-ukraine",
    storageBucket: "monopoly-ukraine.firebasestorage.app",
    messagingSenderId: "1046709502750",
    appId: "1:1046709502750:web:ba8ad3c1f11780d1a6bf0f"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let myPlayerId = 'player_' + Date.now();
let myPlayerName = null;
let currentRoomCode = null;

function generateRoomCode() { return 'GAME-' + Math.random().toString(36).substr(2,4).toUpperCase(); }

window.createRoom = async function() {
    const name = document.getElementById('playerName').value.trim() || '–ì—Ä–∞–≤–µ—Ü—å';
    myPlayerName = name;
    currentRoomCode = generateRoomCode();

    const roomData = {
        code: currentRoomCode,
        status: 'waiting',
        players: {
            [myPlayerId]: {id: myPlayerId, name: myPlayerName, money:15000, pos:0, online:true}
        }
    };
    await set(ref(db, 'rooms/'+currentRoomCode), roomData);
    document.getElementById('roomCodeDisplay').textContent = currentRoomCode;
    document.getElementById('waitingRoom').classList.remove('hidden');
    listenToRoom();
};

window.joinRoom = async function() {
    const name = document.getElementById('playerName').value.trim() || '–ì—Ä–∞–≤–µ—Ü—å';
    const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
    if(!code) return alert('–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥!');

    myPlayerName = name;
    currentRoomCode = code;

    const roomRef = ref(db, 'rooms/'+code);
    onValue(roomRef, async snapshot => {
        const room = snapshot.val();
        if(!room) return alert('–ö—ñ–º–Ω–∞—Ç—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
        const playerCount = Object.keys(room.players||{}).length;
        if(playerCount>=4) return alert('–ö—ñ–º–Ω–∞—Ç–∞ –ø–æ–≤–Ω–∞!');
        await set(ref(db,'rooms/'+code+'/players/'+myPlayerId), {id:myPlayerId,name:myPlayerName,money:15000,pos:0,online:true});
        document.getElementById('roomCodeDisplay').textContent = code;
        document.getElementById('waitingRoom').classList.remove('hidden');
        listenToRoom();
    }, {onlyOnce:true});
};

function listenToRoom(){
    const roomRef = ref(db, 'rooms/'+currentRoomCode);
    onValue(roomRef, snapshot => {
        const room = snapshot.val();
        if(!room) return;
        const playerArray = Object.values(room.players||{});
        document.getElementById('playersList').innerHTML = playerArray.map(p=>`<div>${p.name} ${p.online?'üü¢':'üî¥'}</div>`).join('');
        document.getElementById('startGameBtn').disabled = playerArray.length<2;
        if(room.status==='playing'){
            document.getElementById('lobbyScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('gameRoomCode').textContent = currentRoomCode;
        }
    });
}

window.startGame = async function() {
    await update(ref(db,'rooms/'+currentRoomCode),{status:'playing'});
};

window.rollDice = function() { alert('–•—ñ–¥ –ø—Ä–∞—Ü—é—î! (—Å–ø—Ä–æ—â–µ–Ω–∞ –≤–µ—Ä—Å—ñ—è)'); };
window.leaveGame = function() { location.reload(); };

// Firebase connection test
const statusDiv = document.getElementById('connectionStatus');
onValue(ref(db,'.info/connected'), snap=>{
    if(snap.val()===true){
        statusDiv.textContent = '‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ';
        document.getElementById('lobbyContent').classList.remove('hidden');
    } else { statusDiv.textContent = '‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è'; }
});
</script>

<script>
if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').then(r=>console.log('‚úÖ SW –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π')).catch(e=>console.error('‚ùå SW –ø–æ–º–∏–ª–∫–∞',e));
}
</script>
</body>
</html>